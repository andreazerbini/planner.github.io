<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kanban Covey – Tabs + Tabelle + Drive</title>
    <style>
      :root {
        --bg: #0b0f16;
        --panel: #121826;
        --muted: #9aa4b2;
        --text: #e6edf3;
        --accent: #5eead4;
        --card: #0f172a;
        --border: #263046;
        --warn: #f59e0b;
        --danger: #ef4444;
        --h-header: 56px;
        --h-tabs: 46px;
        --sticky-top: calc(var(--h-header) + var(--h-tabs));
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        color: var(--text);
        background: linear-gradient(120deg, #0b0f16, #0a1322 60%, #0b0f16);
      }

      header {
        position: sticky;
        top: 0;
        z-index: 20;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        height: var(--h-header);
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        background: rgba(11, 15, 22, 0.7);
        backdrop-filter: blur(8px);
      }

      h1 {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 700;
        letter-spacing: 0.2px;
      }

      .tag {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: var(--muted);
        border: 1px solid var(--border);
        border-radius: 999px;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-left: auto;
      }

      button,
      input,
      select,
      textarea {
        font: inherit;
      }

      button {
        padding: 0.55rem 0.75rem;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        background: var(--panel);
        cursor: pointer;
      }

      button:hover {
        border-color: #33405e;
      }

      button.primary {
        color: #061317;
        border-color: transparent;
        background: linear-gradient(135deg, #12b3a6, #6ee7d2);
      }

      button.primary:hover {
        filter: brightness(1.02);
      }

      button.danger {
        color: #2b100f;
        border-color: transparent;
        background: linear-gradient(135deg, #ef4444, #f59e0b);
      }

      nav.tabs {
        position: sticky;
        top: var(--h-header);
        z-index: 15;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        height: var(--h-tabs);
        padding: 0.6rem 1rem;
        border-bottom: 1px solid var(--border);
        background: rgba(11, 15, 22, 0.7);
        backdrop-filter: blur(8px);
      }

      .tab {
        padding: 0.45rem 0.75rem;
        color: var(--muted);
        border: 1px solid var(--border);
        border-radius: 0.65rem;
        cursor: pointer;
        background: transparent;
      }

      .tab.active {
        color: #061317;
        border-color: transparent;
        background: linear-gradient(135deg, #12b3a6, #6ee7d2);
      }

      main {
        display: grid;
        gap: 1rem;
        padding: 1rem;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: rgba(18, 24, 38, 0.7);
        border: 1px solid var(--border);
        border-radius: 0.9rem;
        overflow: hidden;
      }

      thead th {
        /* position: sticky; */
        top: var(--sticky-top);
        z-index: 10;
        padding: 0.7rem 0.8rem;
        font-size: 0.85rem;
        text-align: left;
        white-space: nowrap;
        color: var(--muted);
        user-select: none;
        background: #121826;
        border-bottom: 1px solid var(--border);
      }

      th.sortable {
        cursor: pointer;
      }

      th.sortable::after {
        margin-left: 0.25rem;
        font-size: 0.7rem;
        opacity: 0.35;
        content: "▲▼";
      }

      th.sortable.asc::after {
        content: "▲";
        opacity: 0.85;
      }

      th.sortable.desc::after {
        content: "▼";
        opacity: 0.85;
      }

      tbody td {
        padding: 0.6rem 0.8rem;
        border-bottom: 1px solid #1b2436;
      }

      tbody tr:hover {
        background: #0f1628;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }

      input[type="text"],
      input[type="number"],
      input[type="date"],
      select,
      textarea {
        width: 100%;
        padding: 0.45rem 0.5rem;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        background: #0b1324;
      }

      textarea {
        min-height: 54px;
        resize: vertical;
      }

      .cards {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(4, minmax(240px, 1fr));
      }

      .card {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        padding: 0.8rem;
        border: 1px solid var(--border);
        border-radius: 0.9rem;
        background: var(--card);
      }

      .badge {
        display: inline-block;
        padding: 0.1rem 0.45rem;
        font-size: 0.7rem;
        color: var(--muted);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
      }

      .title {
        font-weight: 700;
      }

      .footer {
        padding: 1rem;
        font-size: 0.85rem;
        color: var(--muted);
        border-top: 1px solid var(--border);
      }

      @media (max-width: 1200px) {
        .cards {
          grid-template-columns: repeat(2, minmax(240px, 1fr));
        }
      }

      @media (max-width: 700px) {
        header {
          align-items: flex-start;
        }

        .cards {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Kanban Covey</h1>
      <span class="tag">Ruoli → LT → BT → Attività</span>
      <div class="actions">
        <button id="export">Esporta JSON</button>
        <button id="importBtn">Importa JSON</button>
        <button id="saveFile">Salva su file</button>
        <button id="openFile">Apri file</button>
        <button id="gSignIn">Connetti Google</button>
        <button id="driveOpen" disabled>Apri da Drive</button>
        <button id="driveSave" disabled>Salva su Drive</button>
        <span id="driveStatus" class="tag" title="Stato Google Drive">Drive: offline</span>
        <button class="danger" id="clear">Azzera</button>
      </div>
    </header>

    <nav id="tabs" class="tabs"></nav>
    <main id="view"></main>

    <footer class="footer">
      <strong>Salvataggio locale:</strong> automatico in <code>localStorage</code>.
      Puoi anche <em>Esportare/Importare</em> JSON.
      Su browser Chromium/Edge puoi usare "Salva su file" e "Apri file" (File System Access API).
      <br />
      Opzionale: connessione a <strong>Google Drive</strong> (inserisci <em>Client ID</em> e <em>API Key</em>) per aprire/salvare il JSON.
    </footer>

    <input id="filePicker" type="file" accept="application/json" hidden />

    <script>
      (() => {
        "use strict";

        // =============================================================
        // Costanti e configurazione di base
        // =============================================================
        const STORAGE_KEYS = Object.freeze({
          STATE: "covey_v2_domain_model",
          GD_CLIENT_ID: "covey_gd_client_id",
          GD_API_KEY: "covey_gd_api_key",
        });

        const DEFAULT_FILE_NAME = "kanban-covey.json";
        const GOOGLE_DISCOVERY_DOCS = [
          "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
        ];
        const GOOGLE_SCOPE = "https://www.googleapis.com/auth/drive.file";

        const tabs = [
          { id: "roles", label: "Ruoli" },
          { id: "lt", label: "Obiettivi a lungo termine" },
          { id: "st", label: "Obiettivi a breve termine" },
          { id: "tasks", label: "Attività" },
          { id: "dash", label: "Dashboard" },
        ];

        // =============================================================
        // Stato applicativo e persistence layer
        // =============================================================
        const AppState = {
          data: loadState(),
          currentFileHandle: null,
          persist() {
            localStorage.setItem(
              STORAGE_KEYS.STATE,
              JSON.stringify(this.data)
            );
          },
          replace(nextState) {
            this.data = nextState;
            this.persist();
          },
          nextId() {
            return String(this.data.nextId++);
          },
        };

        function defaultState() {
          return { nextId: 1, roles: [] };
        }

        function loadState() {
          try {
            const raw = localStorage.getItem(STORAGE_KEYS.STATE);
            if (!raw) return seedState();
            const parsed = JSON.parse(raw);
            return validate(parsed) ? parsed : seedState();
          } catch (err) {
            console.warn("Impossibile leggere lo stato salvato, uso seed.", err);
            return seedState();
          }
        }

        function seedState() {
          const seeded = defaultState();
          const today = () => new Date().toISOString().slice(0, 10);
          const datePlus = (days) => {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return date.toISOString().slice(0, 10);
          };
          const nextId = () => String(seeded.nextId++);

          const role = {
            id: nextId(),
            title: "Team Leader",
            importance: 3,
            lt_goals: [],
          };
          const longTerm = {
            id: nextId(),
            title: "Introdurre ML nel prodotto",
            description: "Roadmap ML (RAG, valutazione, privacy)",
            importance: 5,
            due: datePlus(120),
            st_goals: [],
          };
          const shortTerm = {
            id: nextId(),
            title: "PoC RAG su documentale",
            description: "Pipeline base eval + feedback",
            importance: null,
            due: null,
            tasks: [],
          };
          const task = {
            id: nextId(),
            title: "Progettazione schema vector DB",
            description: "Definire spazio embedding e chunking",
            importance: 4,
            due: datePlus(30),
          };

          shortTerm.tasks.push(task);
          longTerm.st_goals.push(shortTerm);
          role.lt_goals.push(longTerm);
          seeded.roles.push(role);
          return seeded;
        }

        function validate(candidate) {
          return (
            candidate &&
            typeof candidate === "object" &&
            Array.isArray(candidate.roles) &&
            "nextId" in candidate
          );
        }

        // =============================================================
        // Utilità di formattazione e coercizione
        // =============================================================
        const DateUtils = {
          today: () => new Date().toISOString().slice(0, 10),
          addDays(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return date.toISOString().slice(0, 10);
          },
        };

          function toImportance(value, fallback = 1) {
              const parsed = parseInt(value, 10);
              if (Number.isNaN(parsed)) return fallback;
              return Math.max(1, parsed); // ← niente limite superiore
          }

        function toImportanceOrNull(value) {
          if (value == null || value === "") return null;
          return toImportance(value, 1);
        }

        function escapeHtml(value) {
          return (value || "").replace(/[&<>"']/g, (match) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[match]
          );
        }

        // =============================================================
        // Ereditarietà di importanza/scadenza
        // =============================================================
        function effectiveImportance(node, parentImportance) {
          return node.importance != null
            ? toImportance(node.importance, 1)
            : parentImportance;
        }

        function effectiveDueDate(node, parentDueDate) {
          return node.due || parentDueDate || null;
        }

        function clampChildToParent(child, parent) {
          const parentImportance = effectiveImportance(parent, 9999999);
          const parentDue = parent.due || null;

          if (
            child.importance != null &&
            child.importance > parentImportance
          ) {
            child.importance = parentImportance;
          }

          if (parentDue && child.due && child.due > parentDue) {
            child.due = parentDue;
          }
        }

          function cascadeFromRole(role) {
              role.lt_goals.forEach((lt) => {
                  // LT non può superare il Ruolo
                  clampChildToParent(lt, role);

                  lt.st_goals.forEach((st) => {
                      clampChildToParent(st, lt);
                      st.tasks.forEach((task) =>
                          clampChildToParent(task, st.due ? st : lt)
                      );
                  });
              });
          }


        // =============================================================
        // UI references e gestione tab
        // =============================================================
        const dom = {
          tabs: document.getElementById("tabs"),
          view: document.getElementById("view"),
          filePicker: document.getElementById("filePicker"),
          exportBtn: document.getElementById("export"),
          importBtn: document.getElementById("importBtn"),
          saveFileBtn: document.getElementById("saveFile"),
          openFileBtn: document.getElementById("openFile"),
          clearBtn: document.getElementById("clear"),
          driveStatus: document.getElementById("driveStatus"),
          googleBtn: document.getElementById("gSignIn"),
          driveOpenBtn: document.getElementById("driveOpen"),
          driveSaveBtn: document.getElementById("driveSave"),
        };

        let activeTab = "roles";

        function render() {
          renderTabs();
          const renderer = tabRenderers[activeTab];
          if (renderer) renderer();
        }

        function renderTabs() {
          dom.tabs.innerHTML = "";
          tabs.forEach((tab) => {
            const element = document.createElement("button");
            element.className = `tab${activeTab === tab.id ? " active" : ""}`;
            element.textContent = tab.label;
            element.addEventListener("click", () => {
              activeTab = tab.id;
              render();
            });
            dom.tabs.appendChild(element);
          });
        }

        const tabRenderers = {
          roles: renderRoles,
          lt: renderLongTermGoals,
          st: renderShortTermGoals,
          tasks: renderTasks,
          dash: renderDashboard,
        };

        // =============================================================
        // Helper UI element factories
        // =============================================================
        function inputText(value, placeholder, onInput) {
          const input = document.createElement("input");
          input.type = "text";
          input.value = value || "";
          if (placeholder) input.placeholder = placeholder;
          if (onInput) {
            input.addEventListener("input", () => onInput(input.value));
          }
          return input;
        }

        function inputInteger(value, onInput) {
          const input = document.createElement("input");
          input.type = "number";
          input.min = "1";
          // input.max = "99999";
          input.step = "1";
          input.value = value ?? "";
          input.addEventListener("input", () => {
            onInput(input.value === "" ? null : toImportance(input.value));
          });
          return input;
        }

          function inputDate(value, onInput, { readOnly = false } = {}) {
              const input = document.createElement("input");
              input.type = "date";
              input.value = value || "";

              // Solo se esplicitamente richiesto, blocca la digitazione
              if (readOnly) {
                  input.readOnly = true;
                  input.addEventListener("keydown", (e) => e.preventDefault());
              }

              // Apri il calendario automaticamente al focus
              input.addEventListener("focus", () => {
                  // Questo funziona sulla maggior parte dei browser moderni
                  try {
                      input.showPicker?.();
                  } catch (e) {
                      // Fallback silenzioso se non supportato
                  }
              });

              // Aggiorna lo stato quando cambia la data
              input.addEventListener("change", () => {
                  onInput(input.value || null);
              });

              // Anche su input per catturare la digitazione
              input.addEventListener("input", () => {
                  onInput(input.value || null);
              });

              return input;
          }

        function textArea(value, onInput) {
          const area = document.createElement("textarea");
          area.value = value || "";
          area.addEventListener("input", () => onInput(area.value));
          return area;
        }

        function button(label, className, onClick) {
          const btn = document.createElement("button");
          btn.textContent = label;
          if (className) btn.className = className;
          btn.addEventListener("click", onClick);
          return btn;
        }

        function selectRole(selectedId) {
          const select = document.createElement("select");
          AppState.data.roles.forEach((role) => {
            const option = document.createElement("option");
            option.value = role.id;
            option.textContent = role.title;
            select.appendChild(option);
          });
          if (selectedId) select.value = selectedId;
          return select;
        }

        function selectLongTerm(roleId, selectedId) {
          const select = document.createElement("select");
          const role = AppState.data.roles.find((r) => r.id === roleId);
          (role?.lt_goals || []).forEach((goal) => {
            const option = document.createElement("option");
            option.value = goal.id;
            option.textContent = goal.title;
            select.appendChild(option);
          });
          if (selectedId) select.value = selectedId;
          return select;
        }

        function confirmDelete(message) {
          return window.confirm(message || "Sei sicuro? Questa azione è irreversibile.");
        }

        function makeTable(columns, rows) {
          const wrapper = document.createElement("div");
          wrapper.style.overflowX = "auto";

          const table = document.createElement("table");
          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");

          let sortIndex = -1;
          let sortDir = 1;

          function defaultComparator(a, b) {
            if (a == null && b == null) return 0;
            if (a == null) return -1;
            if (b == null) return 1;
            if (a > b) return 1;
            if (a < b) return -1;
            return 0;
          }

          function applySort() {
            if (sortIndex < 0) return;
            const column = columns[sortIndex];
            const comparator = column.sort || ((rowA, rowB) => {
              const key = column.key;
              const a = typeof key === "function" ? key(rowA) : undefined;
              const b = typeof key === "function" ? key(rowB) : undefined;
              return defaultComparator(a, b);
            });
            rows.sort((a, b) => sortDir * comparator(a, b));
          }

          columns.forEach((column, idx) => {
            const th = document.createElement("th");
            th.textContent = column.label;
            if (column.key || column.sort) {
              th.classList.add("sortable");
              th.addEventListener("click", () => {
                if (sortIndex === idx) {
                  sortDir = -sortDir;
                } else {
                  sortIndex = idx;
                  sortDir = 1;
                }

                [...headerRow.children].forEach((el, headerIdx) => {
                  el.classList.remove("asc", "desc");
                  if (headerIdx === sortIndex) {
                    el.classList.add(sortDir === 1 ? "asc" : "desc");
                  }
                });

                applySort();
                renderBody();
              });
            }
            headerRow.appendChild(th);
          });

          thead.appendChild(headerRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");

          function renderBody() {
            tbody.innerHTML = "";
            rows.forEach((row) => {
              const tr = document.createElement("tr");
              columns.forEach((column) => {
                const td = document.createElement("td");
                td.appendChild(column.render(row));
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });
          }

          applySort();
          renderBody();

          table.appendChild(tbody);
          wrapper.appendChild(table);
          return wrapper;
        }

        // =============================================================
        // Tab: Ruoli
        // =============================================================
        function renderRoles() {
          dom.view.innerHTML = "";
          const rows = AppState.data.roles.slice();

          const table = makeTable(
            [
              {
                label: "Titolo",
                key: (role) => (role.title || "").toLowerCase(),
                render: (role) =>
                  inputText(role.title, "Titolo", (value) => {
                    role.title = value;
                    AppState.persist();
                  }),
              },
              {
                label: "Importanza (≥1)",
                key: (role) => role.importance || 0,
                  render: (role) => {
                      const el = inputInteger(role.importance, (value) => {
                          role.importance = toImportance(value ?? 1); // solo stato
                      });
                      const commit = () => {
                          cascadeFromRole(role);
                          AppState.persist();
                          render();
                      };
                      el.addEventListener("blur", commit);
                      el.addEventListener("change", commit); // per sicurezza
                      el.addEventListener("keydown", (e) => { if (e.key === "Enter") el.blur(); });
                      return el;
                  },
              },
              {
                label: "Azioni",
                render: (role) => {
                  const container = document.createElement("div");
                  container.className = "controls";
                  container.append(
                    button("+ LT", "", () => {
                      role.lt_goals.push(
                        createLongTerm(
                          "Nuovo obiettivo LT",
                          "",
                          3,
                          DateUtils.addDays(90)
                        )
                      );
                      AppState.persist();
                      render();
                    }),
                    button("Elimina", "", () => {
                      if (!confirmDelete("Eliminare ruolo e tutti i figli?"))
                        return;
                      AppState.data.roles = AppState.data.roles.filter(
                        (candidate) => candidate.id !== role.id
                      );
                      AppState.persist();
                      render();
                    })
                  );
                  return container;
                },
              },
            ],
            rows
          );

          const toolbar = document.createElement("div");
          toolbar.className = "controls";
          toolbar.appendChild(
            button("+ Ruolo", "primary", () => {
              AppState.data.roles.push(createRole("Nuovo ruolo", 3));
              AppState.persist();
              render();
            })
          );

          dom.view.append(toolbar, table);
        }

        // =============================================================
        // Tab: Obiettivi Lungo Termine (LT)
        // =============================================================
        function renderLongTermGoals() {
          dom.view.innerHTML = "";
          const rows = [];
          AppState.data.roles.forEach((role) =>
            role.lt_goals.forEach((lt) => rows.push({ role, lt }))
          );

          const table = makeTable(
            [
              {
                label: "Ruolo",
                key: (row) => (row.role.title || "").toLowerCase(),
                render: (row) => {
                  const select = selectRole(row.role.id);
                  select.addEventListener("input", () => {
                    const from = row.role;
                    const to = AppState.data.roles.find(
                      (candidate) => candidate.id === select.value
                    );
                    if (!to || from.id === to.id) return;
                    from.lt_goals = from.lt_goals.filter(
                      (goal) => goal.id !== row.lt.id
                    );
                    to.lt_goals.push(row.lt);
                    row.role = to;
                    AppState.persist();
                    render();
                  });
                  return select;
                },
              },
              {
                label: "Titolo",
                key: (row) => (row.lt.title || "").toLowerCase(),
                render: (row) =>
                  inputText(row.lt.title, "Titolo", (value) => {
                    row.lt.title = value;
                    AppState.persist();
                  }),
              },
              {
                label: "Descrizione",
                render: (row) =>
                  textArea(row.lt.description, (value) => {
                    row.lt.description = value;
                    AppState.persist();
                  }),
              },
              {
                label: "Importanza (≥1)",
                key: (row) => row.lt.importance || 0,
                render: (row) =>
                    (() => {
                        const el = inputInteger(row.lt.importance, (value) => {
                            row.lt.importance = toImportance(value ?? 1);
                        });
                        const commit = () => {
                            clampChildToParent(row.lt, row.role);
                            cascadeFromRole(row.role);
                            AppState.persist();
                            render();
                        };
                        el.addEventListener("blur", commit);
                        el.addEventListener("change", commit);
                        el.addEventListener("keydown", (e) => { if (e.key === "Enter") el.blur(); });
                        return el;
                    })(),
              },
              {
                label: "Scadenza",
                key: (row) => row.lt.due || "",
                render: (row) =>
                    (() => {
                        const el = inputDate(row.lt.due, (value) => {
                            row.lt.due = value || DateUtils.today();
                            }, { readOnly: false }); // ← Cambiato a false
                        const commit = () => {
                            clampChildToParent(row.lt, row.role);
                            cascadeFromRole(row.role);
                            AppState.persist();
                            render();
                        };
                        el.addEventListener("blur", commit);
                        el.addEventListener("change", commit);
                        return el;
                    })(),
              }
              ,
              {
                label: "Azioni",
                render: (row) => {
                  const container = document.createElement("div");
                  container.className = "controls";
                  container.append(
                    button("+ BT", "", () => {
                      row.lt.st_goals.push(
                        createShortTerm("Nuovo obiettivo BT", "", null, null)
                      );
                      AppState.persist();
                      render();
                    }),
                    button("Elimina", "", () => {
                      if (
                        !confirmDelete(
                          "Eliminare obiettivo LT e tutti i figli?"
                        )
                      )
                        return;
                      row.role.lt_goals = row.role.lt_goals.filter(
                        (candidate) => candidate.id !== row.lt.id
                      );
                      AppState.persist();
                      render();
                    })
                  );
                  return container;
                },
              },
            ],
            rows
          );

          const toolbar = document.createElement("div");
          toolbar.className = "controls";
          toolbar.appendChild(
            button("+ Obiettivo LT", "primary", () => {
              if (!AppState.data.roles.length) {
                alert("Prima crea almeno un Ruolo.");
                return;
              }
              AppState.data.roles[0].lt_goals.push(
                createLongTerm(
                  "Nuovo obiettivo LT",
                  "",
                  3,
                  DateUtils.addDays(120)
                )
              );
              AppState.persist();
              render();
            })
          );

          dom.view.append(toolbar, table);
        }

        // =============================================================
        // Tab: Obiettivi Breve Termine (ST)
        // =============================================================
        function renderShortTermGoals() {
          dom.view.innerHTML = "";
          const rows = [];
          AppState.data.roles.forEach((role) =>
            role.lt_goals.forEach((lt) =>
              lt.st_goals.forEach((st) => rows.push({ role, lt, st }))
            )
          );

          const table = makeTable(
            [
              {
                label: "Ruolo",
                key: (row) => (row.role.title || "").toLowerCase(),
                render: (row) => {
                  const select = selectRole(row.role.id);
                  select.addEventListener("input", () => {
                    const newRole = AppState.data.roles.find(
                      (candidate) => candidate.id === select.value
                    );
                    if (!newRole || newRole.id === row.role.id) return;
                    row.lt.st_goals = row.lt.st_goals.filter(
                      (candidate) => candidate.id !== row.st.id
                    );
                    if (!newRole.lt_goals.length) {
                      newRole.lt_goals.push(
                        createLongTerm(
                          "Auto creato",
                          "",
                          row.lt.importance,
                          row.lt.due
                        )
                      );
                    }
                    const targetLT = newRole.lt_goals[0];
                    targetLT.st_goals.push(row.st);
                    row.role = newRole;
                    row.lt = targetLT;
                    clampChildToParent(row.st, row.lt);
                    AppState.persist();
                    render();
                  });
                  return select;
                },
              },
              {
                label: "LT",
                key: (row) => (row.lt.title || "").toLowerCase(),
                render: (row) => {
                  const select = selectLongTerm(row.role.id, row.lt.id);
                  select.addEventListener("input", () => {
                    const target = row.role.lt_goals.find(
                      (candidate) => candidate.id === select.value
                    );
                    if (!target) return;
                    row.lt.st_goals = row.lt.st_goals.filter(
                      (candidate) => candidate.id !== row.st.id
                    );
                    target.st_goals.push(row.st);
                    row.lt = target;
                    clampChildToParent(row.st, row.lt);
                    AppState.persist();
                    render();
                  });
                  return select;
                },
              },
              {
                label: "Titolo",
                key: (row) => (row.st.title || "").toLowerCase(),
                render: (row) =>
                  inputText(row.st.title, "Titolo", (value) => {
                    row.st.title = value;
                    AppState.persist();
                  }),
              },
              {
                label: "Descrizione",
                render: (row) =>
                  textArea(row.st.description, (value) => {
                    row.st.description = value;
                    AppState.persist();
                  }),
              },
              {
                label: "Importanza (ereditata se vuota)",
                key: (row) =>
                  effectiveImportance(row.st, row.lt.importance ?? 1) || 0,
                    render: (row) => {
                        const el = inputInteger(row.st.importance, (value) => {
                            row.st.importance = value;
                        });
                        el.addEventListener("blur", () => {
                            clampChildToParent(row.st, row.lt);
                            AppState.persist();
                            render();
                        });
                        return el;
                    }
              },
              {
                label: "Scadenza (ereditata se vuota)",
                key: (row) => effectiveDueDate(row.st, row.lt.due) || "",
                render: (row) => {
                    const el = inputDate(row.st.due, (value) => {
                        row.st.due = value;
                        }, { readOnly: false }); // ← Cambiato a false
                    el.addEventListener("blur", () => {
                        clampChildToParent(row.st, row.lt);
                        AppState.persist();
                        render();
                    });
                    return el;
                }
              }
              ,
              {
                label: "Azioni",
                render: (row) => {
                  const container = document.createElement("div");
                  container.className = "controls";
                  container.append(
                    button("+ Attività", "", () => {
                      row.st.tasks.push(
                        createTask("Nuova attività", "", null, null)
                      );
                      AppState.persist();
                      render();
                    }),
                    button("Elimina", "", () => {
                      if (!confirmDelete("Eliminare obiettivo BT?")) return;
                      row.lt.st_goals = row.lt.st_goals.filter(
                        (candidate) => candidate.id !== row.st.id
                      );
                      AppState.persist();
                      render();
                    })
                  );
                  return container;
                },
              },
            ],
            rows
          );

          const toolbar = document.createElement("div");
          toolbar.className = "controls";
          toolbar.appendChild(
            button("+ Obiettivo BT", "primary", () => {
              if (!AppState.data.roles.length) {
                alert("Crea prima Ruolo > LT");
                return;
              }
              const role = AppState.data.roles[0];
              if (!role.lt_goals.length) {
                role.lt_goals.push(
                  createLongTerm(
                    "Nuovo obiettivo LT",
                    "",
                    3,
                    DateUtils.addDays(120)
                  )
                );
              }
              role.lt_goals[0].st_goals.push(
                createShortTerm("Nuovo obiettivo BT", "", null, null)
              );
              AppState.persist();
              render();
            })
          );

          dom.view.append(toolbar, table);
        }

        // =============================================================
        // Tab: Attività
        // =============================================================
        function renderTasks() {
          dom.view.innerHTML = "";
          const rows = [];
          AppState.data.roles.forEach((role) =>
            role.lt_goals.forEach((lt) =>
              lt.st_goals.forEach((st) =>
                st.tasks.forEach((task) => rows.push({ role, lt, st, task }))
              )
            )
          );

          const table = makeTable(
            [
              {
                label: "Ruolo",
                key: (row) => (row.role.title || "").toLowerCase(),
                render: (row) => {
                  const select = selectRole(row.role.id);
                  select.addEventListener("input", () => {
                    const newRole = AppState.data.roles.find(
                      (candidate) => candidate.id === select.value
                    );
                    if (!newRole || newRole.id === row.role.id) return;
                    row.st.tasks = row.st.tasks.filter(
                      (candidate) => candidate.id !== row.task.id
                    );
                    if (!newRole.lt_goals.length) {
                      newRole.lt_goals.push(
                        createLongTerm(
                          "Auto creato",
                          "",
                          row.lt.importance,
                          row.lt.due
                        )
                      );
                    }
                    const targetLT = newRole.lt_goals[0];
                    if (!targetLT.st_goals.length) {
                      targetLT.st_goals.push(
                        createShortTerm(
                          "Auto creato",
                          "",
                          row.st.importance,
                          row.st.due
                        )
                      );
                    }
                    const targetST = targetLT.st_goals[0];
                    targetST.tasks.push(row.task);
                    row.role = newRole;
                    row.lt = targetLT;
                    row.st = targetST;
                    clampChildToParent(row.task, row.st.due ? row.st : row.lt);
                    AppState.persist();
                    render();
                  });
                  return select;
                },
              },
              {
                label: "LT",
                key: (row) => (row.lt.title || "").toLowerCase(),
                render: (row) => {
                  const select = selectLongTerm(row.role.id, row.lt.id);
                  select.addEventListener("input", () => {
                    const target = row.role.lt_goals.find(
                      (candidate) => candidate.id === select.value
                    );
                    if (!target) return;
                    row.st.tasks = row.st.tasks.filter(
                      (candidate) => candidate.id !== row.task.id
                    );
                    if (!target.st_goals.length) {
                      target.st_goals.push(
                        createShortTerm(
                          "Auto creato",
                          "",
                          row.st.importance,
                          row.st.due
                        )
                      );
                    }
                    const targetST = target.st_goals[0];
                    targetST.tasks.push(row.task);
                    row.lt = target;
                    row.st = targetST;
                    clampChildToParent(row.task, row.st.due ? row.st : row.lt);
                    AppState.persist();
                    render();
                  });
                  return select;
                },
              },
              {
                label: "BT",
                key: (row) => (row.st.title || "").toLowerCase(),
                render: (row) => {
                  const select = document.createElement("select");
                  row.lt.st_goals.forEach((st) => {
                    const option = document.createElement("option");
                    option.value = st.id;
                    option.textContent = st.title;
                    select.appendChild(option);
                  });
                  select.value = row.st.id;
                  select.addEventListener("input", () => {
                    const target = row.lt.st_goals.find(
                      (candidate) => candidate.id === select.value
                    );
                    if (!target) return;
                    row.st.tasks = row.st.tasks.filter(
                      (candidate) => candidate.id !== row.task.id
                    );
                    target.tasks.push(row.task);
                    row.st = target;
                    clampChildToParent(row.task, row.st.due ? row.st : row.lt);
                    AppState.persist();
                    render();
                  });
                  return select;
                },
              },
              {
                label: "Titolo",
                key: (row) => (row.task.title || "").toLowerCase(),
                render: (row) =>
                  inputText(row.task.title, "Titolo", (value) => {
                    row.task.title = value;
                    AppState.persist();
                  }),
              },
              {
                label: "Descrizione",
                render: (row) =>
                  textArea(row.task.description, (value) => {
                    row.task.description = value;
                    AppState.persist();
                  }),
              },
              {
                label: "Importanza (ereditata se vuota)",
                key: (row) =>
                  effectiveImportance(
                    row.task,
                    effectiveImportance(row.st, row.lt.importance)
                  ) || 0,
                  render: (row) => {
                      return inputInteger(row.task.importance, (value) => {
                          row.task.importance = value;
                          clampChildToParent(row.task, row.st.due ? row.st : row.lt);
                          AppState.persist();
                      });
              }
              },
                {
                    label: "Scadenza (ereditata se vuota)",
                    key: (row) =>
                        effectiveDueDate(
                            row.task,
                            effectiveDueDate(row.st, row.lt.due)
                        ) || "",
                    render: (row) => {
                        const el = inputDate(row.task.due, (value) => {
                            row.task.due = value;
                        }, { readOnly: false }); // ← Cambiato a false
                        el.addEventListener("blur", () => {
                            clampChildToParent(row.task, row.st.due ? row.st : row.lt);
                            AppState.persist();
                            render();
                        });
                        return el;
                    }
                }
              ,
              {
                label: "Azioni",
                render: (row) => {
                  const container = document.createElement("div");
                  container.className = "controls";
                  container.appendChild(
                    button("Elimina", "", () => {
                      if (!confirmDelete("Eliminare attività?")) return;
                      row.st.tasks = row.st.tasks.filter(
                        (candidate) => candidate.id !== row.task.id
                      );
                      AppState.persist();
                      render();
                    })
                  );
                  return container;
                },
              },
            ],
            rows
          );

          const toolbar = document.createElement("div");
          toolbar.className = "controls";
          toolbar.appendChild(
            button("+ Attività", "primary", () => {
              if (!AppState.data.roles.length) {
                alert("Crea prima Ruolo > LT > BT");
                return;
              }
              const role = AppState.data.roles[0];
              if (!role.lt_goals.length) {
                role.lt_goals.push(
                  createLongTerm(
                    "Nuovo LT",
                    "",
                    3,
                    DateUtils.addDays(120)
                  )
                );
              }
              const lt = role.lt_goals[0];
              if (!lt.st_goals.length) {
                lt.st_goals.push(createShortTerm("Nuovo BT", "", null, null));
              }
              lt.st_goals[0].tasks.push(
                createTask("Nuova attività", "", null, null)
              );
              AppState.persist();
              render();
            })
          );

          dom.view.append(toolbar, table);
        }

        // =============================================================
        // Tab: Dashboard
        // =============================================================
        function renderDashboard() {
          dom.view.innerHTML = "";
          const cardsContainer = document.createElement("div");
          cardsContainer.className = "cards";

          const longTermItems = [];
          AppState.data.roles.forEach((role) =>
            role.lt_goals.forEach((lt) => longTermItems.push({ role, lt }))
          );
          longTermItems.sort((a, b) => (a.lt.due || "").localeCompare(b.lt.due || ""));
          longTermItems.slice(0, 8).forEach((item) => {
            cardsContainer.appendChild(createLongTermCard(item));
          });

          const upcomingTasks = [];
          AppState.data.roles.forEach((role) =>
            role.lt_goals.forEach((lt) =>
              lt.st_goals.forEach((st) =>
                st.tasks.forEach((task) => {
                  const due = effectiveDueDate(
                    task,
                    effectiveDueDate(st, lt.due)
                  );
                  if (due) {
                    const diff = (new Date(due) - new Date()) / 86400000;
                    if (diff <= 14) {
                      upcomingTasks.push({ role, lt, st, task, due });
                    }
                  }
                })
              )
            )
          );

          upcomingTasks.sort((a, b) => (a.due || "").localeCompare(b.due || ""));
          upcomingTasks.slice(0, 8).forEach((item) => {
            cardsContainer.appendChild(createTaskCard(item));
          });

          dom.view.appendChild(cardsContainer);
        }

        function createLongTermCard({ role, lt }) {
          const card = document.createElement("article");
          card.className = "card";
          const title = document.createElement("div");
          title.className = "title";
          title.textContent = lt.title;
          const meta = document.createElement("div");
          meta.innerHTML = `
            <span class="badge">Ruolo: ${escapeHtml(role.title)}</span>
            <span class="badge">Imp: ${lt.importance}</span>
            <span class="badge">Scadenza: ${escapeHtml(lt.due || "-")}</span>`;
          const desc = document.createElement("div");
          desc.textContent = lt.description || "—";
          const goBtn = button("Vai a LT", "", () => {
            activeTab = "lt";
            render();
          });
          card.append(title, meta, desc, goBtn);
          return card;
        }

        function createTaskCard({ role, lt, st, task, due }) {
          const card = document.createElement("article");
          card.className = "card";
          const title = document.createElement("div");
          title.className = "title";
          title.textContent = task.title;
          const meta = document.createElement("div");
          meta.innerHTML = `
            <span class="badge">${escapeHtml(role.title)} › ${escapeHtml(lt.title)} › ${escapeHtml(st.title)}</span>
            <span class="badge">Imp: ${effectiveImportance(
              task,
              effectiveImportance(st, lt.importance)
            )}</span>
            <span class="badge">Scadenza: ${escapeHtml(due || "-")}</span>`;
          const desc = document.createElement("div");
          desc.textContent = task.description || "—";
          const goBtn = button("Vai a Attività", "", () => {
            activeTab = "tasks";
            render();
          });
          card.append(title, meta, desc, goBtn);
          return card;
        }

        // =============================================================
        // Factory function per creare nuovi elementi del dominio
        // =============================================================
        function createRole(title, importance) {
          return {
            id: AppState.nextId(),
            title,
            importance: toImportance(importance, 1),
            lt_goals: [],
          };
        }

        function createLongTerm(title, description, importance, due) {
          return {
            id: AppState.nextId(),
            title,
            description: description || "",
            importance: toImportance(importance, 1),
            due: due || DateUtils.today(),
            st_goals: [],
          };
        }

        function createShortTerm(title, description, importance, due) {
          return {
            id: AppState.nextId(),
            title,
            description: description || "",
            importance: toImportanceOrNull(importance),
            due: due || null,
            tasks: [],
          };
        }

        function createTask(title, description, importance, due) {
          return {
            id: AppState.nextId(),
            title,
            description: description || "",
            importance: toImportanceOrNull(importance),
            due: due || null,
          };
        }

        // =============================================================
        // Export / Import JSON
        // =============================================================
        dom.exportBtn.addEventListener("click", () => {
          const blob = new Blob([JSON.stringify(AppState.data, null, 2)], {
            type: "application/json",
          });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = DEFAULT_FILE_NAME;
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(link.href);
        });

        dom.importBtn.addEventListener("click", () => dom.filePicker.click());

        dom.filePicker.addEventListener("change", async (event) => {
          const file = event.target.files?.[0];
          if (!file) return;
          try {
            const content = await file.text();
            const parsed = JSON.parse(content);
            if (!validate(parsed)) {
              alert("JSON non valido");
              return;
            }
            AppState.replace(parsed);
            render();
          } catch (error) {
            alert(`Errore import: ${error.message}`);
          } finally {
            dom.filePicker.value = "";
          }
        });

        // =============================================================
        // File System Access API
        // =============================================================
        const FileSystem = {
          supported:
            "showSaveFilePicker" in window && "showOpenFilePicker" in window,
        };

        dom.saveFileBtn.addEventListener("click", async () => {
          if (!FileSystem.supported) {
            alert(
              "Il tuo browser non supporta il salvataggio diretto. Usa Esporta JSON."
            );
            return;
          }
          try {
            if (!AppState.currentFileHandle) {
              AppState.currentFileHandle = await window.showSaveFilePicker({
                suggestedName: DEFAULT_FILE_NAME,
                types: [
                  {
                    description: "JSON",
                    accept: { "application/json": [".json"] },
                  },
                ],
              });
            }
            const writable = await AppState.currentFileHandle.createWritable();
            await writable.write(JSON.stringify(AppState.data, null, 2));
            await writable.close();
            alert("Salvato ✅");
          } catch (error) {
            if (error.name !== "AbortError") {
              alert(`Errore salvataggio: ${error.message}`);
            }
          }
        });

        dom.openFileBtn.addEventListener("click", async () => {
          if (!FileSystem.supported) {
            alert(
              "Il tuo browser non supporta l'apertura diretta. Usa Importa JSON."
            );
            return;
          }
          try {
            const [handle] = await window.showOpenFilePicker({
              types: [
                {
                  description: "JSON",
                  accept: { "application/json": [".json"] },
                },
              ],
            });
            AppState.currentFileHandle = handle;
            const file = await handle.getFile();
            const content = await file.text();
            const parsed = JSON.parse(content);
            if (!validate(parsed)) {
              alert("JSON non valido");
              return;
            }
            AppState.replace(parsed);
            render();
          } catch (error) {
            if (error.name !== "AbortError") {
              alert(`Errore apertura: ${error.message}`);
            }
          }
        });

        dom.clearBtn.addEventListener("click", () => {
          if (!confirmDelete("Sicuro di azzerare tutto?")) return;
          AppState.replace(defaultState());
          render();
        });

        // =============================================================
        // Google Drive integration (opzionale)
        // =============================================================
        const GoogleDrive = {
          CLIENT_ID: localStorage.getItem(STORAGE_KEYS.GD_CLIENT_ID) || "",
          API_KEY: localStorage.getItem(STORAGE_KEYS.GD_API_KEY) || "",
          DISCOVERY_DOCS: GOOGLE_DISCOVERY_DOCS,
          SCOPES: GOOGLE_SCOPE,
          tokenClient: null,
          gapiLoaded: false,
          gisLoaded: false,
          signedIn: false,
          currentFileId: null,
        };

        function updateDriveUI() {
          dom.driveStatus.textContent = GoogleDrive.signedIn
            ? "Drive: connesso"
            : "Drive: offline";
          dom.driveOpenBtn.disabled = !GoogleDrive.signedIn;
          dom.driveSaveBtn.disabled = !GoogleDrive.signedIn;
        }

        function saveDriveCredentials() {
          localStorage.setItem(STORAGE_KEYS.GD_CLIENT_ID, GoogleDrive.CLIENT_ID);
          localStorage.setItem(STORAGE_KEYS.GD_API_KEY, GoogleDrive.API_KEY);
        }

        function askForDriveCredentials() {
          const clientId = prompt(
            "Inserisci il tuo Google OAuth CLIENT_ID (tipo ...apps.googleusercontent.com):",
            GoogleDrive.CLIENT_ID || ""
          );
          if (!clientId) return false;
          const apiKey = prompt(
            "Inserisci la tua Google API KEY:",
            GoogleDrive.API_KEY || ""
          );
          if (!apiKey) return false;
          GoogleDrive.CLIENT_ID = clientId.trim();
          GoogleDrive.API_KEY = apiKey.trim();
          saveDriveCredentials();
          return true;
        }

        function loadGapi() {
          return new Promise((resolve, reject) => {
            if (GoogleDrive.gapiLoaded) {
              resolve();
              return;
            }
            const script = document.createElement("script");
            script.src = "https://apis.google.com/js/api.js";
            script.onload = () => {
              gapi.load("client", async () => {
                try {
                  await gapi.client.init({
                    apiKey: GoogleDrive.API_KEY,
                    discoveryDocs: GoogleDrive.DISCOVERY_DOCS,
                  });
                  GoogleDrive.gapiLoaded = true;
                  resolve();
                } catch (error) {
                  reject(error);
                }
              });
            };
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        function loadGoogleIdentityServices() {
          return new Promise((resolve, reject) => {
            if (GoogleDrive.gisLoaded) {
              resolve();
              return;
            }
            const script = document.createElement("script");
            script.src = "https://accounts.google.com/gsi/client";
            script.onload = () => {
              try {
                GoogleDrive.tokenClient = google.accounts.oauth2.initTokenClient({
                  client_id: GoogleDrive.CLIENT_ID,
                  scope: GoogleDrive.SCOPES,
                  callback: (response) => {
                    if (response && response.access_token) {
                      GoogleDrive.signedIn = true;
                      updateDriveUI();
                    }
                  },
                });
                GoogleDrive.gisLoaded = true;
                resolve();
              } catch (error) {
                reject(error);
              }
            };
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        async function ensureDriveReady() {
         // if (location.protocol === "file:") {
         //   alert(
         //     "Per usare Google Drive apri la pagina da http://localhost o https://"
         //   );
         //   return false;
         // }
          if (!GoogleDrive.CLIENT_ID || !GoogleDrive.API_KEY) {
            const ok = askForDriveCredentials();
            if (!ok) return false;
          }
          try {
            await loadGoogleIdentityServices();
          } catch (error) {
            alert(`Errore GIS: ${error.message || error}`);
            return false;
          }
          try {
            await loadGapi();
          } catch (error) {
            console.warn("Uso fallback REST (senza discovery):", error);
          }
          return true;
        }

        async function driveFetch(path, params = {}, method = "GET", body = null) {
          const tokenObj = google.accounts.oauth2.getToken?.();
          const token = tokenObj && tokenObj.access_token;
          if (!token) throw new Error('Nessun access token disponibile. Premi "Connetti Google".');
          const url = new URL(`https://www.googleapis.com/drive/v3/${path}`);
          Object.entries(params).forEach(([key, value]) =>
            url.searchParams.set(key, value)
          );
          const response = await fetch(url.toString(), {
            method,
            headers: {
              Authorization: `Bearer ${token}`,
              ...(body ? { "Content-Type": "application/json" } : {}),
            },
            body: body ? JSON.stringify(body) : null,
          });
          if (!response.ok) {
            throw new Error(`Drive REST error ${response.status}: ${await response.text()}`);
          }
          return response.json();
        }

        async function listJsonFilesFallback() {
          const q = "mimeType='application/json' and trashed=false";
          return driveFetch("files", {
            q,
            fields: "files(id,name,modifiedTime)",
            pageSize: "25",
          });
        }

        async function getFileContentFallback(fileId) {
          const tokenObj = google.accounts.oauth2.getToken?.();
          const token = tokenObj && tokenObj.access_token;
          const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(
            fileId
          )}?alt=media`;
          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          if (!response.ok) {
            throw new Error(`Download error ${response.status}`);
          }
          return response.text();
        }

        async function uploadOrUpdateJsonFallback(name, content, fileId) {
          const boundary = "-------314159265358979323846";
          const delimiter = `\r\n--${boundary}\r\n`;
          const closeDelimiter = `\r\n--${boundary}--`;
          const metadata = { name, mimeType: "application/json" };
          const multipartBody =
            `${delimiter}Content-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}` +
            `${delimiter}Content-Type: application/json\r\n\r\n${content}${closeDelimiter}`;

          const tokenObj = google.accounts.oauth2.getToken?.();
          const token = tokenObj && tokenObj.access_token;
          const method = fileId ? "PATCH" : "POST";
          const path = fileId ? `files/${encodeURIComponent(fileId)}` : "files";
          const response = await fetch(
            `https://www.googleapis.com/upload/drive/v3/${path}?uploadType=multipart`,
            {
              method,
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": `multipart/related; boundary=${boundary}`,
              },
              body: multipartBody,
            }
          );
          if (!response.ok) {
            throw new Error(`Upload error ${response.status}: ${await response.text()}`);
          }
          const json = await response.json();
          return json.id;
        }

        dom.googleBtn.addEventListener("click", async () => {
          if (!(await ensureDriveReady())) return;
          try {
            GoogleDrive.tokenClient.requestAccessToken({ prompt: "consent" });
          } catch (error) {
            alert(`Autorizzazione Google fallita: ${error.message || error}`);
          }
        });

        dom.driveOpenBtn.addEventListener("click", async () => {
          try {
            if (!(await ensureDriveReady())) return;
            let files = [];
            if (GoogleDrive.gapiLoaded && window.gapi?.client?.drive) {
              try {
                const response = await gapi.client.drive.files.list({
                  q: "mimeType='application/json' and trashed=false",
                  pageSize: 25,
                  fields: "files(id,name,modifiedTime)",
                });
                files = response.result.files || [];
              } catch (error) {
                console.warn("gapi list fallita, passo a REST fallback:", error);
              }
            }
            if (!files.length) {
              const response = await listJsonFilesFallback();
              files = response.files || [];
            }
            if (!files.length) {
              alert("Nessun JSON trovato nel tuo Drive.");
              return;
            }
            const nameList = files
              .map(
                (file, index) =>
                  `${index + 1}) ${file.name} — ${new Date(
                    file.modifiedTime
                  ).toLocaleString()}`
              )
              .join("\n");
            const idx = prompt(`Scegli file da aprire (numero):\n${nameList}`);
            const selectedIndex = Number(idx) - 1;
            if (!(selectedIndex >= 0 && selectedIndex < files.length)) return;
            const file = files[selectedIndex];
            let text;
            if (GoogleDrive.gapiLoaded && window.gapi?.client?.drive) {
              try {
                const download = await gapi.client.drive.files.get({
                  fileId: file.id,
                  alt: "media",
                });
                text = download.body;
              } catch (error) {
                console.warn("gapi download fallito, uso REST:", error);
                text = await getFileContentFallback(file.id);
              }
            } else {
              text = await getFileContentFallback(file.id);
            }
            const data = JSON.parse(text);
            if (!validate(data)) {
              alert("JSON non valido");
              return;
            }
            AppState.replace(data);
            GoogleDrive.currentFileId = file.id;
            alert(`Aperto da Drive: ${file.name}`);
            render();
          } catch (error) {
            alert(`Errore apertura Drive: ${error.message || error}`);
          }
        });

        dom.driveSaveBtn.addEventListener("click", async () => {
          try {
            if (!(await ensureDriveReady())) return;
            const fileName = DEFAULT_FILE_NAME;
            const content = JSON.stringify(AppState.data, null, 2);
            if (GoogleDrive.gapiLoaded && window.gapi?.client?.drive) {
              try {
                const boundary = "-------314159265358979323846";
                const delimiter = `\r\n--${boundary}\r\n`;
                const closeDelimiter = `\r\n--${boundary}--`;
                const metadata = { name: fileName, mimeType: "application/json" };
                const multipartBody =
                  `${delimiter}Content-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}` +
                  `${delimiter}Content-Type: application/json\r\n\r\n${content}${closeDelimiter}`;

                if (GoogleDrive.currentFileId) {
                  await gapi.client.request({
                    path: `/upload/drive/v3/files/${encodeURIComponent(
                      GoogleDrive.currentFileId
                    )}`,
                    method: "PATCH",
                    params: { uploadType: "multipart" },
                    headers: {
                      "Content-Type": `multipart/related; boundary=${boundary}`,
                    },
                    body: multipartBody,
                  });
                  alert("Aggiornato su Drive ✅");
                } else {
                  const response = await gapi.client.request({
                    path: "/upload/drive/v3/files",
                    method: "POST",
                    params: { uploadType: "multipart" },
                    headers: {
                      "Content-Type": `multipart/related; boundary=${boundary}`,
                    },
                    body: multipartBody,
                  });
                  GoogleDrive.currentFileId = response.result?.id || null;
                  alert("Salvato su Drive ✅");
                }
                return;
              } catch (error) {
                console.warn("gapi upload fallito, uso REST:", error);
              }
            }
            GoogleDrive.currentFileId = await uploadOrUpdateJsonFallback(
              fileName,
              content,
              GoogleDrive.currentFileId
            );
            alert("Salvato su Drive (REST) ✅");
          } catch (error) {
            alert(`Errore salvataggio Drive: ${error.message || error}`);
          }
        });

        updateDriveUI();
        render();
      })();
    </script>
  </body>
</html>
